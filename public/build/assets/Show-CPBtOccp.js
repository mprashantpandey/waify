import{r as l,j as r}from"./react-BhzSerM2.js";import{u as S,H as C,q as A}from"./vendor-YQoUUhbX.js";import{A as D}from"./AppShell-A6sQ3pxr.js";import{C as I,b as M,c as T,d as E,a as $}from"./Card-CRSrZ5HZ.js";import{a as R,B as g}from"./app-DjsbE74r.js";import"./Topbar-D6SeU-QE.js";import"./Badge-C6d-QEGL.js";import"./GlobalFlashHandler-DjMhmIiM.js";import"./useToast-C37H2DkG.js";import"./BrandingWrapper-Djq-D_tN.js";import"./Alert-u60ICsin.js";import"./CookieConsentBanner-C37xsP7H.js";/* empty css            */const u=s=>{if(!s||s.id==null||!s.created_at)return null;const e=Number(s.id);return!Number.isInteger(e)||e<1?null:{id:e,sender_type:String(s.sender_type??"user"),sender_id:s.sender_id==null?null:Number(s.sender_id),body:String(s.body??""),created_at:String(s.created_at),attachments:Array.isArray(s.attachments)?s.attachments:[]}},y=(s,e)=>{const d=new Map;for(const i of s)d.set(i.id,i);for(const i of e){const o=d.get(i.id);d.set(i.id,o?{...o,...i}:i)}return Array.from(d.values()).sort((i,o)=>new Date(i.created_at).getTime()-new Date(o.created_at).getTime())},F=s=>s.mime_type?s.mime_type.startsWith("image/"):/\.(png|jpe?g|gif|webp|svg)$/i.test(s.file_name),H=s=>s.mime_type?s.mime_type==="application/pdf":/\.pdf$/i.test(s.file_name);function V({account:s,thread:e,messages:d}){const{data:i,setData:o,post:p,processing:x,reset:j}=S({message:"",attachments:[]}),{subscribe:f}=R(),_=l.useMemo(()=>(Array.isArray(d)?d:[]).map(u).filter(t=>t!==null),[d]),[k,m]=l.useState(_),b=l.useRef(null);l.useEffect(()=>{const t=(Array.isArray(d)?d:[]).map(u).filter(n=>n!==null);if(b.current!==e.id){m(t),b.current=e.id;return}t.length>0&&m(n=>y(n,t))},[d,e.id]);const h=l.useCallback(t=>{const a=Array.isArray(t)?t.map(u).filter(n=>n!==null):[];a.length!==0&&m(n=>y(n,a))},[]);l.useEffect(()=>{const t=`account.${s.id}.support.thread.${e.id}`,a=f(t,"support.message.created",n=>{if(n?.thread_id&&Number(n.thread_id)!==e.id)return;const c=u(n);c&&m(w=>y(w,[c]))});return()=>{a()}},[f,s.id,e.id]),l.useEffect(()=>{if((e.channel??"ticket")!=="live")return;const t=async()=>{try{const c=(await window.axios.get(route("app.support.live",{}),{headers:{Accept:"application/json"}})).data;if(!c?.thread?.id||Number(c.thread.id)!==e.id)return;h(c.messages??[])}catch{}},a=window.setInterval(()=>{t()},5e3);return()=>window.clearInterval(a)},[e.channel,e.id,h]);const N=t=>{t.preventDefault(),p(route("app.support.message",{thread:e.slug??e.id}),{forceFormData:!0,onSuccess:()=>j()})},v=()=>{p(route("app.support.close",{thread:e.slug??e.id}))};return r.jsxs(D,{children:[r.jsx(C,{title:`Support - ${e.subject}`}),r.jsxs("div",{className:"space-y-6",children:[r.jsx(A,{href:route("app.support.hub",{}),className:"inline-flex items-center gap-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 transition-colors",children:"← Back to Support Hub"}),r.jsxs(I,{className:"border-0 shadow-lg",children:[r.jsxs(M,{className:"bg-gradient-to-r from-gray-50 to-white dark:from-gray-800 dark:to-gray-900",children:[r.jsx(T,{className:"text-xl font-bold",children:e.subject}),r.jsxs(E,{children:["Status: ",e.status]})]}),r.jsxs($,{className:"p-6 space-y-4",children:[r.jsxs("div",{className:"grid gap-2 text-xs text-gray-500 dark:text-gray-400 md:grid-cols-2",children:[r.jsxs("div",{children:["Category: ",e.category||"—"]}),r.jsxs("div",{children:["Tags: ",e.tags&&e.tags.length>0?e.tags.join(", "):"—"]}),r.jsxs("div",{children:["First response due:"," ",e.first_response_due_at?new Date(e.first_response_due_at).toLocaleString():"—"]}),r.jsxs("div",{children:["Resolution due: ",e.due_at?new Date(e.due_at).toLocaleString():"—"]}),r.jsxs("div",{children:["Escalation level: ",e.escalation_level??0]})]}),e.status==="closed"&&r.jsx("div",{className:"rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm text-gray-700 dark:text-gray-200 px-4 py-3",children:"This chat is closed. You can start a new request anytime."}),r.jsx("div",{className:"space-y-3",children:k.map(t=>r.jsxs("div",{className:`rounded-lg px-4 py-3 ${t.sender_type==="admin"||t.sender_type==="bot"?"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":t.sender_type==="system"?"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800":"bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700"}`,children:[r.jsx("div",{className:"text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-1",children:t.sender_type==="admin"?"Support":t.sender_type==="bot"?"Assistant":t.sender_type==="system"?"System":"You"}),r.jsx("div",{className:"text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap",children:t.body}),t.attachments&&t.attachments.length>0&&r.jsx("div",{className:"mt-2 space-y-2",children:t.attachments.map(a=>r.jsxs("div",{className:"space-y-2",children:[r.jsx("a",{href:a.url,target:"_blank",rel:"noreferrer",className:"block text-xs text-blue-600 dark:text-blue-300 hover:underline",children:a.file_name}),F(a)&&r.jsx("img",{src:a.url,alt:a.file_name,className:"max-h-40 rounded-md border border-gray-200 dark:border-gray-700"}),H(a)&&r.jsxs("details",{className:"text-xs text-gray-600 dark:text-gray-300",children:[r.jsx("summary",{className:"cursor-pointer",children:"Preview PDF"}),r.jsx("iframe",{src:a.url,className:"mt-2 h-48 w-full rounded-md border border-gray-200 dark:border-gray-700"})]})]},a.id))}),r.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:new Date(t.created_at).toLocaleString()})]},t.id))}),r.jsxs("form",{onSubmit:N,className:"space-y-3",children:[r.jsx("textarea",{value:i.message,onChange:t=>o("message",t.target.value),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",rows:4,placeholder:"Write your reply..."}),r.jsx("input",{type:"file",multiple:!0,onChange:t=>o("attachments",Array.from(t.target.files||[])),className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-gray-100 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-gray-700 hover:file:bg-gray-200 dark:file:bg-gray-800 dark:file:text-gray-200 dark:hover:file:bg-gray-700"}),r.jsxs("div",{className:"flex justify-end",children:[e.status==="open"&&r.jsx(g,{type:"button",variant:"secondary",onClick:v,className:"mr-2",children:"Close Chat"}),e.status==="closed"&&r.jsx(g,{type:"button",variant:"secondary",onClick:()=>p(route("app.support.reopen",{thread:e.slug??e.id})),className:"mr-2",children:"Reopen Chat"}),r.jsx(g,{type:"submit",disabled:x||e.status==="closed"||i.message.trim().length===0&&i.attachments.length===0,children:x?"Sending...":"Send Message"})]})]})]})]})]})]})}export{V as default};
