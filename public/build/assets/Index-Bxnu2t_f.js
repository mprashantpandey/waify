import{r as c,j as t}from"./react-BhzSerM2.js";import{o as ne,a as re,k as B,H as ie,q as L,f as H,b4 as oe,b5 as le,a7 as ce,X as de,M as Q,aX as ue}from"./vendor-YQoUUhbX.js";import{A as me}from"./AppShell-A6sQ3pxr.js";import{B as ge}from"./Badge-C6d-QEGL.js";import{a as xe,i as R,B as X}from"./app-DjsbE74r.js";import{C as pe}from"./Skeleton-CfTHwkjJ.js";import{E as he}from"./EmptyState-C-qCOnBR.js";import{u as fe}from"./useToast-C37H2DkG.js";import{T as we}from"./TextInput-DRXLElIV.js";import"./Topbar-D6SeU-QE.js";import"./GlobalFlashHandler-DjMhmIiM.js";import"./BrandingWrapper-Djq-D_tN.js";import"./Alert-u60ICsin.js";import"./CookieConsentBanner-C37xsP7H.js";/* empty css            */const U=n=>{if(!n||n.id==null)return null;const p=Number(n.id),w=Number(n?.connection?.id);if(!Number.isInteger(p)||p<1||!Number.isInteger(w)||w<1)return null;const _=String(n?.contact?.wa_id??"").trim(),f=String(n?.contact?.name??_??"").trim();return{id:p,account_id:n.account_id,contact:{id:Number(n?.contact?.id??0),wa_id:_,name:f||_||"Unknown"},status:String(n.status??"open"),last_message_preview:n.last_message_preview??null,last_message_at:n.last_message_at??null,connection:{id:w,name:String(n?.connection?.name??"Unknown")},assigned_to:n.assigned_to==null?null:Number(n.assigned_to),priority:n.priority??null}},M=n=>Array.isArray(n)?n.map(U).filter(p=>p!==null):[];function Re({account:n,conversations:p,connections:w,agents:_=[],filters:f={search:""}}){const{subscribe:k,connected:G}=xe(),{addToast:S}=fe(),{auth:A}=ne().props,y=A?.user?.id,P=A?.user?.notify_assignment_enabled??!0,$=A?.user?.notify_sound_enabled??!0,[q,v]=c.useState(M(p?.data)),[Y,_e]=c.useState(!1),[x,C]=c.useState(f?.search??""),[u,D]=c.useState(f?.status??"all"),[m,I]=c.useState(f?.connection_id!==void 0&&f?.connection_id!=="all"?Number(f.connection_id):"all"),[g,T]=c.useState(f?.assignee??"all"),[J,z]=c.useState(null),E=Array.isArray(_)?_:[],V=c.useRef(new Date),h=c.useRef(new Set),O=c.useRef(new Map(M(p?.data).map(e=>[e.id,e.assigned_to??null]))),W=c.useCallback(()=>{if($)try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return;const a=new e,r=a.createOscillator(),s=a.createGain();r.type="sine",r.frequency.value=880,s.gain.value=.04,r.connect(s),s.connect(a.destination),r.start(),r.stop(a.currentTime+.12)}catch{console.warn("[Notifications] Unable to play sound")}},[$]),Z=e=>e?new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",ee=typeof window<"u"&&window.axios?window.axios:re,b=c.useCallback(()=>{if(!n?.id)return;const e=new Date(Date.now()-120*1e3).toISOString();ee.get(route("app.whatsapp.inbox.stream",{}),{params:{since:e}}).then(a=>{const r=a.data?.updated_conversations;if(!r?.length)return;const s=n?.id;v(o=>{const l=new Map(o.map(i=>[i.id,i]));return r.forEach(i=>{const d=U(i);d&&(s!=null&&d.account_id!=null&&!R(d.account_id,s)||l.set(d.id,d))}),Array.from(l.values()).sort((i,d)=>{const j=i.last_message_at?new Date(i.last_message_at).getTime():0;return(d.last_message_at?new Date(d.last_message_at).getTime():0)-j})}),V.current=new Date(a.data?.server_time||new Date)}).catch(a=>console.warn("[Inbox] Stream fetch failed:",a?.message))},[n?.id]);c.useEffect(()=>{v(M(p?.data))},[p]);const F=c.useRef(f?.search??"");c.useEffect(()=>{const e=setTimeout(()=>{x!==F.current&&(F.current=x,B.get(route("app.whatsapp.conversations.index",{}),{search:x||void 0,assignee:g!=="all"?g:void 0,status:u!=="all"?u:void 0,connection_id:m!=="all"?m:void 0},{preserveState:!0}))},400);return()=>clearTimeout(e)},[x]);const N=c.useRef({assignee:g,status:u,connection_id:m});c.useEffect(()=>{N.current.assignee===g&&N.current.status===u&&N.current.connection_id===m||(N.current={assignee:g,status:u,connection_id:m},B.get(route("app.whatsapp.conversations.index",{}),{search:x||void 0,assignee:g!=="all"?g:void 0,status:u!=="all"?u:void 0,connection_id:m!=="all"?m:void 0},{preserveState:!0}))},[g,u,m]);const K=c.useMemo(()=>q.filter(e=>{if(e.account_id!=null&&n?.id!=null&&!R(e.account_id,n.id))return!1;if(x){const a=x.toLowerCase(),r=e.contact.name?.toLowerCase().includes(a),s=e.contact.wa_id?.toLowerCase().includes(a),o=e.last_message_preview?.toLowerCase().includes(a);if(!r&&!s&&!o)return!1}if(u!=="all"&&e.status!==u||m!=="all"&&e.connection.id!==m)return!1;if(g==="me"){if(y==null||e.assigned_to!==y)return!1}else if(g==="unassigned"&&e.assigned_to!=null)return!1;return!0}),[q,n?.id,x,u,m,g,y]),te=(e,a)=>{const r=e.findIndex(s=>s.id===a.id);if(r>=0){const s=[...e];return s[r]=a,s.sort((o,l)=>{const i=o.last_message_at?new Date(o.last_message_at).getTime():0;return(l.last_message_at?new Date(l.last_message_at).getTime():0)-i})}else return[a,...e].sort((s,o)=>{const l=s.last_message_at?new Date(s.last_message_at).getTime():0;return(o.last_message_at?new Date(o.last_message_at).getTime():0)-l})},se=(e,a)=>{const r=a.conversation_id,s=e.findIndex(o=>o.id===r);if(s>=0){const o={...e[s]};o.last_message_preview=a.message?.text_body??a.message?.text??a.message?.body??"New message",o.last_message_at=a.message?.created_at??a.message?.timestamp??new Date().toISOString();const l=[...e];return l[s]=o,l.sort((i,d)=>{const j=i.last_message_at?new Date(i.last_message_at).getTime():0;return(d.last_message_at?new Date(d.last_message_at).getTime():0)-j})}return e};return c.useEffect(()=>{if(!n?.id)return;const e=`account.${n.id}.whatsapp.inbox`,a=k(e,".whatsapp.conversation.updated",s=>{const o=`conv-updated-${s.conversation?.id}-${s.conversation?.updated_at||s.conversation?.last_message_at||""}`;if(!h.current.has(o)){h.current.add(o);const l=s.conversation||{},i=U({...l,assigned_to:l.assignee_id??l.assigned_to??null,last_message_at:l.last_message_at??l.last_activity_at??null});if(!i||n?.id!=null&&i.account_id!=null&&!R(i.account_id,n.id))return;if(v(d=>te(d,i)),y&&P&&i.assigned_to===y&&O.current.get(i.id)!==i.assigned_to&&(S({title:"Conversation assigned",description:"A chat was assigned to you.",variant:"info",duration:3e3}),W()),O.current.set(i.id,i.assigned_to??null),h.current.size>100){const d=Array.from(h.current);h.current=new Set(d.slice(-50))}}}),r=k(e,".whatsapp.message.created",s=>{const o=`msg-created-${s.message?.id}-${s.conversation_id}`;if(!h.current.has(o)&&(h.current.add(o),v(l=>{const i=l.some(j=>j.id===s.conversation_id),d=se(l,s);return!i&&s.conversation_id&&b(),d}),s.message?.direction==="inbound"&&S({title:"New message",description:`From ${s.contact?.name||s.message?.from}`,variant:"info",duration:3e3}),h.current.size>100)){const l=Array.from(h.current);h.current=new Set(l.slice(-50))}});return()=>{a(),r()}},[n?.id,k,S,y,P,W,b]),c.useEffect(()=>{if(!n?.id)return;const e=setInterval(b,2e4);return b(),()=>clearInterval(e)},[n?.id,b]),c.useEffect(()=>{const e=a=>{(a.metaKey||a.ctrlKey)&&a.key==="k"&&(a.preventDefault(),document.querySelector('input[type="search"]')?.focus())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),t.jsxs(me,{children:[t.jsx(ie,{title:"Inbox"}),t.jsx("div",{className:"h-[calc(100vh-8rem)] lg:h-[calc(100vh-6rem)]",children:t.jsxs("div",{className:"grid h-full lg:grid-cols-[360px_1fr] rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl",children:[t.jsxs("section",{className:"flex flex-col border-r border-gray-200 dark:border-gray-800",children:[t.jsx("div",{className:"px-5 py-4 bg-[#075E54] text-white",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex min-w-0 flex-1 items-center gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wider text-white/70",children:"WhatsApp"}),t.jsx("h1",{className:"text-xl font-semibold",children:"Chats"})]}),t.jsxs(L,{href:route("app.whatsapp.conversations.new"),className:"shrink-0 inline-flex items-center gap-1.5 rounded-full bg-white/20 px-3 py-1.5 text-xs font-medium text-white hover:bg-white/30","aria-label":"Start new conversation",children:[t.jsx(H,{className:"h-3.5 w-3.5","aria-hidden":!0}),"New chat"]})]}),t.jsx("div",{className:"flex shrink-0 items-center gap-2 text-xs",children:G?t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-white/15 px-2 py-1",children:[t.jsx(oe,{className:"h-3 w-3"}),"Live"]}):t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-white/15 px-2 py-1",children:[t.jsx(le,{className:"h-3 w-3"}),"Polling"]})})]})}),t.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900",children:[t.jsxs("div",{className:"relative",children:[t.jsx(ce,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),t.jsx(we,{type:"search",value:x,onChange:e=>C(e.target.value),placeholder:"Search or start new chat",className:"pl-9 rounded-full bg-white dark:bg-gray-800"})]}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsxs("select",{value:u,onChange:e=>D(e.target.value),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[t.jsx("option",{value:"all",children:"All"}),t.jsx("option",{value:"open",children:"Open"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"closed",children:"Closed"})]}),w&&w.length>0&&t.jsxs("select",{value:m,onChange:e=>I(e.target.value==="all"?"all":Number(e.target.value)),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[t.jsx("option",{value:"all",children:"All numbers"}),w.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:g,onChange:e=>T(e.target.value),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[t.jsx("option",{value:"all",children:"All assignees"}),t.jsx("option",{value:"me",children:"Assigned to me"}),t.jsx("option",{value:"unassigned",children:"Unassigned"})]}),(x||u!=="all"||m!=="all"||g!=="all")&&t.jsxs("button",{onClick:()=>{C(""),D("all"),I("all"),T("all")},className:"ml-auto text-xs text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 inline-flex items-center gap-1","aria-label":"Clear filters",children:[t.jsx(de,{className:"h-3.5 w-3.5"}),"Clear"]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:Y?t.jsx("div",{className:"p-2",children:[...Array(5)].map((e,a)=>t.jsx(pe,{},a))}):K.length===0?t.jsx("div",{className:"p-6",children:t.jsx(he,{icon:Q,title:x||u!=="all"||m!=="all"||g!=="all"?"No chats match your filters":"No chats yet",description:x||u!=="all"||m!=="all"||g!=="all"?"Try clearing filters or start a new conversation.":"Start a conversation from New chat or when a contact messages you.",action:x||u!=="all"||m!=="all"||g!=="all"?t.jsx(X,{type:"button",variant:"secondary",onClick:()=>{C(""),D("all"),I("all"),T("all")},children:"Clear filters"}):t.jsx(L,{href:route("app.whatsapp.conversations.new"),children:t.jsxs(X,{className:"bg-[#25D366] hover:bg-[#20BD5A] text-white",children:[t.jsx(H,{className:"h-4 w-4 mr-2","aria-hidden":!0}),"New chat"]})})})}):t.jsx("div",{className:"divide-y divide-gray-200 dark:divide-gray-800",children:K.map(e=>{const a=e.assigned_to?E.find(r=>r.id===e.assigned_to)?.name??"—":"—";return t.jsxs("div",{className:"group flex items-start gap-2 px-4 py-3 hover:bg-[#f0f2f5] dark:hover:bg-gray-800 transition-colors",children:[t.jsxs(L,{href:route("app.whatsapp.conversations.show",{conversation:e.id}),className:"min-w-0 flex-1 flex items-start gap-3",children:[t.jsx("div",{className:"h-11 w-11 shrink-0 rounded-full bg-[#25D366] text-white flex items-center justify-center font-semibold text-lg",children:e.contact.name?.charAt(0).toUpperCase()||e.contact.wa_id.charAt(0)}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-gray-900 dark:text-gray-100",children:e.contact.name||e.contact.wa_id}),t.jsx("span",{className:"text-[11px] text-gray-500 dark:text-gray-400 shrink-0 ml-1",children:Z(e.last_message_at)})]}),t.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:t.jsx("span",{className:"truncate",children:e.last_message_preview||"No messages yet"})}),t.jsxs("div",{className:"mt-1 flex items-center gap-2 flex-wrap",children:[t.jsx(ge,{variant:e.status==="open"?"success":"default",className:"px-2 py-0.5 text-[10px]",children:e.status}),t.jsx("span",{className:"text-[11px] text-gray-400",children:"•"}),t.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-gray-500",children:[t.jsx(ue,{className:"h-3 w-3"}),e.connection.name]}),t.jsx("span",{className:"text-[11px] text-gray-400",children:"•"}),t.jsx("span",{className:"text-[11px] text-gray-500",title:"Assignee",children:a})]})]})]}),E.length>0&&t.jsx("div",{className:"shrink-0 pt-0.5",onClick:r=>r.preventDefault(),onMouseDown:r=>r.stopPropagation(),children:t.jsxs("select",{value:e.assigned_to??"",disabled:J===e.id,onChange:r=>{const s=r.target.value,o=s===""?null:Number(s);z(e.id),v(l=>l.map(i=>i.id===e.id?{...i,assigned_to:o}:i)),B.post(route("app.whatsapp.conversations.update",{conversation:e.id}),{assigned_to:o},{preserveState:!0,preserveScroll:!0,onFinish:()=>z(null)})},className:"rounded border-gray-300 dark:border-gray-600 dark:bg-gray-800 text-[11px] py-1 px-2 max-w-[120px] truncate focus:border-[#25D366] focus:ring-[#25D366]",title:"Assign to",children:[t.jsx("option",{value:"",children:"Unassigned"}),E.map(r=>t.jsx("option",{value:r.id,children:r.name},r.id))]})})]},e.id)})})})]}),t.jsx("section",{className:"hidden lg:flex flex-col items-center justify-center bg-[#efeae2] dark:bg-gray-950",children:t.jsxs("div",{className:"text-center max-w-md px-8",children:[t.jsx("div",{className:"mx-auto mb-5 h-16 w-16 rounded-2xl bg-white/70 dark:bg-gray-900 flex items-center justify-center shadow-sm",children:t.jsx(Q,{className:"h-8 w-8 text-[#075E54]"})}),t.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:"WhatsApp Inbox"}),t.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:"Select a chat to start messaging. Your conversations update live as messages arrive."})]})})]})})]})}export{Re as default};
