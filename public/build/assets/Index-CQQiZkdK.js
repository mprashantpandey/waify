import{r as c,j as e}from"./react-B_HteL0F.js";import{H as P,aQ as F,aR as M,aa as R,X as $,M as D,l as W,aF as O,a as q}from"./vendor-GYTC5Pip.js";import{A as K}from"./AppShell-HrBHfcoG.js";import{B as Q}from"./Topbar-CPirX8py.js";import{a as U}from"./app-C0WBMkkY.js";import{C as z}from"./Skeleton-DT9aH67B.js";import{u as H}from"./useToast-Rch7lQVh.js";import{T as X}from"./TextInput-79R2a16S.js";import"./GlobalFlashHandler-DpywDQft.js";import"./BrandingWrapper-DIBfDp2T.js";/* empty css            */function ce({workspace:d,conversations:A,connections:h}){const{subscribe:p,connected:f}=U(),{addToast:w}=H(),[v,y]=c.useState(A.data),[T,Y]=c.useState(!1),[x,j]=c.useState(""),[g,b]=c.useState("all"),[u,N]=c.useState("all"),[_,k]=c.useState(null),C=c.useRef(new Date),o=c.useRef(new Set),L=t=>t?new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",S=c.useMemo(()=>v.filter(t=>{if(x){const s=x.toLowerCase(),l=t.contact.name?.toLowerCase().includes(s),a=t.contact.wa_id?.toLowerCase().includes(s),r=t.last_message_preview?.toLowerCase().includes(s);if(!l&&!a&&!r)return!1}return!(g!=="all"&&t.status!==g||u!=="all"&&t.connection.id!==u)}),[v,x,g,u]),B=(t,s)=>{const l=t.findIndex(a=>a.id===s.id);if(l>=0){const a=[...t];return a[l]=s,a.sort((r,n)=>{const i=r.last_message_at?new Date(r.last_message_at).getTime():0;return(n.last_message_at?new Date(n.last_message_at).getTime():0)-i})}else return[s,...t].sort((a,r)=>{const n=a.last_message_at?new Date(a.last_message_at).getTime():0;return(r.last_message_at?new Date(r.last_message_at).getTime():0)-n})},E=(t,s)=>{const l=s.conversation_id,a=t.findIndex(r=>r.id===l);if(a>=0){const r={...t[a]};r.last_message_preview=s.message?.text||s.message?.body||"New message",r.last_message_at=s.message?.timestamp||new Date().toISOString();const n=[...t];return n[a]=r,n.sort((i,m)=>{const I=i.last_message_at?new Date(i.last_message_at).getTime():0;return(m.last_message_at?new Date(m.last_message_at).getTime():0)-I})}return t};return c.useEffect(()=>{if(!d?.id)return;const t=`private-workspace.${d.id}.whatsapp.inbox`,s=p(t,".whatsapp.conversation.updated",a=>{const r=`conv-updated-${a.conversation?.id}-${Date.now()}`;if(!o.current.has(r)&&(o.current.add(r),y(n=>B(n,a.conversation)),o.current.size>100)){const n=Array.from(o.current);o.current=new Set(n.slice(-50))}}),l=p(t,".whatsapp.message.created",a=>{const r=`msg-created-${a.message?.id}-${a.conversation_id}`;if(!o.current.has(r)&&(o.current.add(r),y(n=>{const i=E(n,a);return a.message?.direction==="inbound"&&w({title:"New message",description:`From ${a.contact?.name||a.message?.from}`,variant:"info",duration:3e3}),i}),o.current.size>100)){const n=Array.from(o.current);o.current=new Set(n.slice(-50))}});return()=>{s(),l()}},[d?.id,p,w]),c.useEffect(()=>{if(f||!d?.id){_&&(clearInterval(_),k(null));return}const t=async()=>{try{const l=await q.get(route("app.whatsapp.inbox.stream",{workspace:d.slug}),{params:{since:C.current.toISOString()}});l.data.updated_conversations?.length>0&&y(a=>{let r=[...a];return l.data.updated_conversations.forEach(n=>{const i=r.findIndex(m=>m.id===n.id);i>=0?r[i]=n:r.unshift(n)}),r.sort((n,i)=>{const m=n.last_message_at?new Date(n.last_message_at).getTime():0;return(i.last_message_at?new Date(i.last_message_at).getTime():0)-m})}),C.current=new Date(l.data.server_time||new Date)}catch(l){console.error("[Inbox] Polling error:",l)}},s=setInterval(t,3e4);return k(s),t(),()=>{clearInterval(s)}},[f,d?.id,d?.slug]),c.useEffect(()=>{const t=s=>{(s.metaKey||s.ctrlKey)&&s.key==="k"&&(s.preventDefault(),document.querySelector('input[type="search"]')?.focus())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[]),e.jsxs(K,{children:[e.jsx(P,{title:"Inbox"}),e.jsx("div",{className:"h-[calc(100vh-8rem)] lg:h-[calc(100vh-6rem)]",children:e.jsxs("div",{className:"grid h-full lg:grid-cols-[360px_1fr] rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl",children:[e.jsxs("section",{className:"flex flex-col border-r border-gray-200 dark:border-gray-800",children:[e.jsx("div",{className:"px-5 py-4 bg-[#075E54] text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wider text-white/70",children:"WhatsApp"}),e.jsx("h1",{className:"text-xl font-semibold",children:"Chats"})]}),e.jsx("div",{className:"flex items-center gap-2 text-xs",children:f?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-white/15 px-2 py-1",children:[e.jsx(F,{className:"h-3 w-3"}),"Live"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-white/15 px-2 py-1",children:[e.jsx(M,{className:"h-3 w-3"}),"Polling"]})})]})}),e.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900",children:[e.jsxs("div",{className:"relative",children:[e.jsx(R,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(X,{type:"search",value:x,onChange:t=>j(t.target.value),placeholder:"Search or start new chat",className:"pl-9 rounded-full bg-white dark:bg-gray-800"})]}),e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[e.jsxs("select",{value:g,onChange:t=>b(t.target.value),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"closed",children:"Closed"})]}),h&&h.length>0&&e.jsxs("select",{value:u,onChange:t=>N(t.target.value==="all"?"all":Number(t.target.value)),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[e.jsx("option",{value:"all",children:"All numbers"}),h.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),(x||g!=="all"||u!=="all")&&e.jsxs("button",{onClick:()=>{j(""),b("all"),N("all")},className:"ml-auto text-xs text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 inline-flex items-center gap-1","aria-label":"Clear filters",children:[e.jsx($,{className:"h-3.5 w-3.5"}),"Clear"]})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:T?e.jsx("div",{className:"p-2",children:[...Array(5)].map((t,s)=>e.jsx(z,{},s))}):S.length===0?e.jsxs("div",{className:"p-10 text-center",children:[e.jsx("div",{className:"mx-auto mb-4 h-12 w-12 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center",children:e.jsx(D,{className:"h-6 w-6 text-gray-400"})}),e.jsx("p",{className:"text-sm text-gray-500",children:x||g!=="all"||u!=="all"?"No chats match your filters.":"No chats yet."})]}):e.jsx("div",{className:"divide-y divide-gray-200 dark:divide-gray-800",children:S.map(t=>e.jsx(W,{href:route("app.whatsapp.conversations.show",{workspace:d.slug,conversation:t.id}),className:"group block px-4 py-3 hover:bg-[#f0f2f5] dark:hover:bg-gray-800 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-full bg-[#25D366] text-white flex items-center justify-center font-semibold text-lg",children:t.contact.name?.charAt(0).toUpperCase()||t.contact.wa_id.charAt(0)}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"truncate text-sm font-semibold text-gray-900 dark:text-gray-100",children:t.contact.name||t.contact.wa_id}),e.jsx("span",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:L(t.last_message_at)})]}),e.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:e.jsx("span",{className:"truncate",children:t.last_message_preview||"No messages yet"})}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[e.jsx(Q,{variant:t.status==="open"?"success":"default",className:"px-2 py-0.5 text-[10px]",children:t.status}),e.jsx("span",{className:"text-[11px] text-gray-400",children:"â€¢"}),e.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-gray-500",children:[e.jsx(O,{className:"h-3 w-3"}),t.connection.name]})]})]})]})},t.id))})})]}),e.jsx("section",{className:"hidden lg:flex flex-col items-center justify-center bg-[#efeae2] dark:bg-gray-950",children:e.jsxs("div",{className:"text-center max-w-md px-8",children:[e.jsx("div",{className:"mx-auto mb-5 h-16 w-16 rounded-2xl bg-white/70 dark:bg-gray-900 flex items-center justify-center shadow-sm",children:e.jsx(D,{className:"h-8 w-8 text-[#075E54]"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:"WhatsApp Inbox"}),e.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:"Select a chat to start messaging. Your conversations update live as messages arrive."})]})})]})})]})}export{ce as default};
