import{r as o,j as t}from"./react-BhzSerM2.js";import{u as G,a as X,e as Y,H as J,l as I,a0 as $,b0 as V,b1 as Z,am as ee,X as te,M as O,aT as se}from"./vendor-DxGhd0kb.js";import{A as ae}from"./AppShell-BB77liAb.js";import{B as re}from"./Badge-Dmpsa1zd.js";import{a as ne,i as C,B as U}from"./app-CUdtZvAA.js";import{C as ie}from"./Skeleton-CfTHwkjJ.js";import{E as le}from"./EmptyState-C-qCOnBR.js";import{u as oe}from"./useToast-m6H8bvjE.js";import{T as ce}from"./TextInput-DRXLElIV.js";import"./Topbar-DS5R2nuh.js";import"./GlobalFlashHandler-xHP6pVTU.js";import"./BrandingWrapper-DK418oSm.js";import"./Alert-0kUZKT4N.js";import"./CookieConsentBanner-DBs8YRGi.js";/* empty css            */function Se({account:c,conversations:p,connections:_,filters:D={search:""}}){const{subscribe:v,connected:W}=ne(),{addToast:b}=oe(),{auth:j}=G().props,N=j?.user?.id,T=j?.user?.notify_assignment_enabled??!0,E=j?.user?.notify_sound_enabled??!0,[B,y]=o.useState(Array.isArray(p?.data)?p.data:[]),[q,de]=o.useState(!1),[d,k]=o.useState(D?.search??""),[x,S]=o.useState("all"),[h,A]=o.useState("all"),F=o.useRef(new Date),g=o.useRef(new Set),L=o.useRef(new Map(p.data.map(e=>[e.id,e.assigned_to??null]))),R=o.useCallback(()=>{if(E)try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return;const s=new e,l=s.createOscillator(),a=s.createGain();l.type="sine",l.frequency.value=880,a.gain.value=.04,l.connect(a),a.connect(s.destination),l.start(),l.stop(s.currentTime+.12)}catch{console.warn("[Notifications] Unable to play sound")}},[E]),K=e=>e?new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",z=typeof window<"u"&&window.axios?window.axios:X,w=o.useCallback(()=>{if(!c?.id)return;const e=new Date(Date.now()-120*1e3).toISOString();z.get(route("app.whatsapp.inbox.stream",{}),{params:{since:e}}).then(s=>{const l=s.data?.updated_conversations;if(!l?.length)return;const a=c?.id;y(i=>{const r=new Map(i.map(n=>[n.id,n]));return l.forEach(n=>{a!=null&&n.account_id!=null&&!C(n.account_id,a)||r.set(n.id,n)}),Array.from(r.values()).sort((n,m)=>{const u=n.last_message_at?new Date(n.last_message_at).getTime():0;return(m.last_message_at?new Date(m.last_message_at).getTime():0)-u})}),F.current=new Date(s.data?.server_time||new Date)}).catch(s=>console.warn("[Inbox] Stream fetch failed:",s?.message))},[c?.id]);o.useEffect(()=>{Array.isArray(p?.data)&&y(p.data)},[p]);const M=o.useRef(D?.search??"");o.useEffect(()=>{const e=setTimeout(()=>{d!==M.current&&(M.current=d,Y.get(route("app.whatsapp.conversations.index",{}),{search:d||void 0},{preserveState:!0}))},400);return()=>clearTimeout(e)},[d]);const P=o.useMemo(()=>B.filter(e=>{if(e.account_id!=null&&c?.id!=null&&!C(e.account_id,c.id))return!1;if(d){const s=d.toLowerCase(),l=e.contact.name?.toLowerCase().includes(s),a=e.contact.wa_id?.toLowerCase().includes(s),i=e.last_message_preview?.toLowerCase().includes(s);if(!l&&!a&&!i)return!1}return!(x!=="all"&&e.status!==x||h!=="all"&&e.connection.id!==h)}),[B,c?.id,d,x,h]),H=(e,s)=>{const l=e.findIndex(a=>a.id===s.id);if(l>=0){const a=[...e];return a[l]=s,a.sort((i,r)=>{const n=i.last_message_at?new Date(i.last_message_at).getTime():0;return(r.last_message_at?new Date(r.last_message_at).getTime():0)-n})}else return[s,...e].sort((a,i)=>{const r=a.last_message_at?new Date(a.last_message_at).getTime():0;return(i.last_message_at?new Date(i.last_message_at).getTime():0)-r})},Q=(e,s)=>{const l=s.conversation_id,a=e.findIndex(i=>i.id===l);if(a>=0){const i={...e[a]};i.last_message_preview=s.message?.text_body??s.message?.text??s.message?.body??"New message",i.last_message_at=s.message?.created_at??s.message?.timestamp??new Date().toISOString();const r=[...e];return r[a]=i,r.sort((n,m)=>{const u=n.last_message_at?new Date(n.last_message_at).getTime():0;return(m.last_message_at?new Date(m.last_message_at).getTime():0)-u})}return e};return o.useEffect(()=>{if(!c?.id)return;const e=`account.${c.id}.whatsapp.inbox`,s=v(e,".whatsapp.conversation.updated",a=>{const i=`conv-updated-${a.conversation?.id}-${a.conversation?.updated_at||a.conversation?.last_message_at||""}`;if(!g.current.has(i)){g.current.add(i);const r=a.conversation||{},n=Number(r.id);if(!Number.isInteger(n)||n<1)return;const m=r.account_id!=null?Number(r.account_id):void 0;if(c?.id!=null&&m!=null&&m!==c.id)return;const u={id:n,account_id:m,contact:r.contact??{id:0,wa_id:"",name:""},status:r.status??"open",last_message_preview:r.last_message_preview??null,last_message_at:r.last_message_at??r.last_activity_at??null,connection:r.connection??{id:0,name:""},assigned_to:r.assignee_id??r.assigned_to??null,priority:r.priority??null};if(y(f=>H(f,u)),N&&T&&u.assigned_to===N&&L.current.get(u.id)!==u.assigned_to&&(b({title:"Conversation assigned",description:"A chat was assigned to you.",variant:"info",duration:3e3}),R()),L.current.set(u.id,u.assigned_to??null),g.current.size>100){const f=Array.from(g.current);g.current=new Set(f.slice(-50))}}}),l=v(e,".whatsapp.message.created",a=>{const i=`msg-created-${a.message?.id}-${a.conversation_id}`;if(!g.current.has(i)&&(g.current.add(i),y(r=>{const n=r.some(u=>u.id===a.conversation_id),m=Q(r,a);return!n&&a.conversation_id&&w(),m}),a.message?.direction==="inbound"&&b({title:"New message",description:`From ${a.contact?.name||a.message?.from}`,variant:"info",duration:3e3}),g.current.size>100)){const r=Array.from(g.current);g.current=new Set(r.slice(-50))}});return()=>{s(),l()}},[c?.id,v,b,N,T,R,w]),o.useEffect(()=>{if(!c?.id)return;const e=setInterval(w,2e4);return w(),()=>clearInterval(e)},[c?.id,w]),o.useEffect(()=>{const e=s=>{(s.metaKey||s.ctrlKey)&&s.key==="k"&&(s.preventDefault(),document.querySelector('input[type="search"]')?.focus())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),t.jsxs(ae,{children:[t.jsx(J,{title:"Inbox"}),t.jsx("div",{className:"h-[calc(100vh-8rem)] lg:h-[calc(100vh-6rem)]",children:t.jsxs("div",{className:"grid h-full lg:grid-cols-[360px_1fr] rounded-3xl overflow-hidden border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-xl",children:[t.jsxs("section",{className:"flex flex-col border-r border-gray-200 dark:border-gray-800",children:[t.jsx("div",{className:"px-5 py-4 bg-[#075E54] text-white",children:t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex min-w-0 flex-1 items-center gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-xs uppercase tracking-wider text-white/70",children:"WhatsApp"}),t.jsx("h1",{className:"text-xl font-semibold",children:"Chats"})]}),t.jsxs(I,{href:route("app.whatsapp.conversations.new"),className:"shrink-0 inline-flex items-center gap-1.5 rounded-full bg-white/20 px-3 py-1.5 text-xs font-medium text-white hover:bg-white/30","aria-label":"Start new conversation",children:[t.jsx($,{className:"h-3.5 w-3.5","aria-hidden":!0}),"New chat"]})]}),t.jsx("div",{className:"flex shrink-0 items-center gap-2 text-xs",children:W?t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-white/15 px-2 py-1",children:[t.jsx(V,{className:"h-3 w-3"}),"Live"]}):t.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-white/15 px-2 py-1",children:[t.jsx(Z,{className:"h-3 w-3"}),"Polling"]})})]})}),t.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900",children:[t.jsxs("div",{className:"relative",children:[t.jsx(ee,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),t.jsx(ce,{type:"search",value:d,onChange:e=>k(e.target.value),placeholder:"Search or start new chat",className:"pl-9 rounded-full bg-white dark:bg-gray-800"})]}),t.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[t.jsxs("select",{value:x,onChange:e=>S(e.target.value),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[t.jsx("option",{value:"all",children:"All"}),t.jsx("option",{value:"open",children:"Open"}),t.jsx("option",{value:"pending",children:"Pending"}),t.jsx("option",{value:"closed",children:"Closed"})]}),_&&_.length>0&&t.jsxs("select",{value:h,onChange:e=>A(e.target.value==="all"?"all":Number(e.target.value)),className:"rounded-full border-gray-300 shadow-sm focus:border-[#25D366] focus:ring-[#25D366] dark:bg-gray-800 dark:border-gray-700 text-xs px-3 py-1.5",children:[t.jsx("option",{value:"all",children:"All numbers"}),_.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),(d||x!=="all"||h!=="all")&&t.jsxs("button",{onClick:()=>{k(""),S("all"),A("all")},className:"ml-auto text-xs text-gray-500 hover:text-gray-900 dark:hover:text-gray-100 inline-flex items-center gap-1","aria-label":"Clear filters",children:[t.jsx(te,{className:"h-3.5 w-3.5"}),"Clear"]})]})]}),t.jsx("div",{className:"flex-1 overflow-y-auto",children:q?t.jsx("div",{className:"p-2",children:[...Array(5)].map((e,s)=>t.jsx(ie,{},s))}):P.length===0?t.jsx("div",{className:"p-6",children:t.jsx(le,{icon:O,title:d||x!=="all"||h!=="all"?"No chats match your filters":"No chats yet",description:d||x!=="all"||h!=="all"?"Try clearing filters or start a new conversation.":"Start a conversation from New chat or when a contact messages you.",action:d||x!=="all"||h!=="all"?t.jsx(U,{type:"button",variant:"secondary",onClick:()=>{k(""),S("all"),A("all")},children:"Clear filters"}):t.jsx(I,{href:route("app.whatsapp.conversations.new"),children:t.jsxs(U,{className:"bg-[#25D366] hover:bg-[#20BD5A] text-white",children:[t.jsx($,{className:"h-4 w-4 mr-2","aria-hidden":!0}),"New chat"]})})})}):t.jsx("div",{className:"divide-y divide-gray-200 dark:divide-gray-800",children:P.map(e=>t.jsx(I,{href:(()=>{const s=parseInt(String(e.id),10),l=e.account_id==null||C(e.account_id,c?.id);return Number.isInteger(s)&&s>=1&&l?route("app.whatsapp.conversations.show",{conversation:s}):"#"})(),className:"group block px-4 py-3 hover:bg-[#f0f2f5] dark:hover:bg-gray-800 transition-colors",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"h-11 w-11 rounded-full bg-[#25D366] text-white flex items-center justify-center font-semibold text-lg",children:e.contact.name?.charAt(0).toUpperCase()||e.contact.wa_id.charAt(0)}),t.jsxs("div",{className:"min-w-0 flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("p",{className:"truncate text-sm font-semibold text-gray-900 dark:text-gray-100",children:e.contact.name||e.contact.wa_id}),t.jsx("span",{className:"text-[11px] text-gray-500 dark:text-gray-400",children:K(e.last_message_at)})]}),t.jsx("div",{className:"flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:t.jsx("span",{className:"truncate",children:e.last_message_preview||"No messages yet"})}),t.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[t.jsx(re,{variant:e.status==="open"?"success":"default",className:"px-2 py-0.5 text-[10px]",children:e.status}),t.jsx("span",{className:"text-[11px] text-gray-400",children:"â€¢"}),t.jsxs("div",{className:"flex items-center gap-1 text-[11px] text-gray-500",children:[t.jsx(se,{className:"h-3 w-3"}),e.connection.name]})]})]})]})},e.id))})})]}),t.jsx("section",{className:"hidden lg:flex flex-col items-center justify-center bg-[#efeae2] dark:bg-gray-950",children:t.jsxs("div",{className:"text-center max-w-md px-8",children:[t.jsx("div",{className:"mx-auto mb-5 h-16 w-16 rounded-2xl bg-white/70 dark:bg-gray-900 flex items-center justify-center shadow-sm",children:t.jsx(O,{className:"h-8 w-8 text-[#075E54]"})}),t.jsx("h2",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:"WhatsApp Inbox"}),t.jsx("p",{className:"mt-2 text-sm text-gray-600 dark:text-gray-400",children:"Select a chat to start messaging. Your conversations update live as messages arrive."})]})})]})})]})}export{Se as default};
