import{r as o,j as e}from"./react-BhzSerM2.js";import{u as H,o as G,H as W,q,a as R,k as J}from"./vendor-YQoUUhbX.js";import{P as V}from"./PlatformShell-Bb_kh9A7.js";import{C as y,b,c as f,d as h,a as j}from"./Card-CRSrZ5HZ.js";import{a as K,B as u}from"./app-DjsbE74r.js";import{u as Q}from"./useToast-C37H2DkG.js";import"./Topbar-D6SeU-QE.js";import"./Badge-C6d-QEGL.js";import"./BrandingWrapper-Djq-D_tN.js";import"./GlobalFlashHandler-DjMhmIiM.js";/* empty css            */const k=r=>{if(!r||r.id==null||!r.created_at)return null;const n=Number(r.id);return!Number.isInteger(n)||n<1?null:{id:n,sender_type:String(r.sender_type??"user"),sender_id:r.sender_id==null?null:Number(r.sender_id),body:String(r.body??""),created_at:String(r.created_at),attachments:Array.isArray(r.attachments)?r.attachments:[]}},S=(r,n)=>{const c=new Map;for(const d of r)c.set(d.id,d);for(const d of n){const l=c.get(d.id);c.set(d.id,l?{...l,...d}:d)}return Array.from(c.values()).sort((d,l)=>new Date(d.created_at).getTime()-new Date(l.created_at).getTime())},X=r=>r.mime_type?r.mime_type.startsWith("image/"):/\.(png|jpe?g|gif|webp|svg)$/i.test(r.file_name),Y=r=>r.mime_type?r.mime_type==="application/pdf":/\.pdf$/i.test(r.file_name);function ce({thread:r,messages:n,admins:c,auditLogs:d}){const{data:l,setData:v,post:C,processing:A,reset:E}=H({message:"",attachments:[]}),{subscribe:D}=K(),{addToast:M}=Q(),{ai:N}=G().props,$=o.useMemo(()=>(Array.isArray(n)?n:[]).map(k).filter(t=>t!==null),[n]),[F,p]=o.useState($),[g,T]=o.useState(!1),[i,x]=o.useState({status:r.status,priority:r.priority||"normal",assigned_to:r.assigned_to||"",category:r.category||"",tags:(r.tags||[]).join(", ")}),[_,L]=o.useState(null),I=o.useRef(null);o.useEffect(()=>{const t=(Array.isArray(n)?n:[]).map(k).filter(a=>a!==null);if(I.current!==r.id){p(t),I.current=r.id;return}t.length>0&&p(a=>S(a,t))},[n,r.id]);const P=o.useCallback(t=>{const s=Array.isArray(t)?t.map(k).filter(a=>a!==null):[];s.length!==0&&p(a=>S(a,s))},[]);o.useEffect(()=>{if(!r.account)return;const t=`account.${r.account.id}.support.thread.${r.id}`,s=D(t,"support.message.created",a=>{if(a?.thread_id&&Number(a.thread_id)!==r.id)return;const m=k(a);m&&p(B=>S(B,[m]))});return()=>{s()}},[D,r.id,r.account?.id]),o.useEffect(()=>{if((r.channel??"ticket")!=="live")return;const t=async()=>{try{const m=(await R.get(route("platform.support.live.thread",{thread:r.slug??r.id}),{headers:{Accept:"application/json"}})).data;if(!m?.thread?.id||Number(m.thread.id)!==r.id)return;P(m.messages??[])}catch{}},s=window.setInterval(()=>{t()},5e3);return()=>window.clearInterval(s)},[r.channel,r.id,r.slug,P]);const O=t=>{t.preventDefault(),C(route("platform.support.message",{thread:r.slug??r.id}),{forceFormData:!0,onSuccess:()=>E()})},U=()=>{C(route("platform.support.close",{thread:r.slug??r.id}))},z=t=>{t.preventDefault();const s=i.tags.split(",").map(a=>a.trim()).filter(Boolean);J.post(route("platform.support.update",{thread:r.slug??r.id}),{status:i.status,priority:i.priority,assigned_to:i.assigned_to||null,category:i.category||null,tags:s})},w=async t=>{T(!0);try{const a=(await R.post(route("platform.support.assistant",{thread:r.slug??r.id}),{action:t},{headers:{Accept:"application/json"}})).data?.suggestion;a&&t==="reply"?(v("message",a),L(null)):a&&L({title:t==="summary"?"AI Summary":"AI Next Steps",content:a})}catch(s){M({title:"AI Assistant",description:s?.response?.data?.error||"Unable to generate a suggestion.",variant:"error"})}finally{T(!1)}};return e.jsxs(V,{children:[e.jsx(W,{title:`Support - ${r.subject}`}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:r.subject}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["Tenant: ",r.account?.name??"Unknown"," · Status: ",r.status]}),r.account&&e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs text-gray-600 dark:text-gray-300",children:[e.jsxs("span",{children:["Owner: ",r.account.owner?.name||"—"]}),e.jsx("span",{children:"·"}),e.jsx("span",{children:r.account.owner?.email||"—"}),e.jsx("span",{children:"·"}),e.jsx("a",{href:route("platform.accounts.show",{account:r.account.id}),className:"text-blue-600 dark:text-blue-300 hover:underline",children:"View Tenant"}),e.jsx("span",{children:"·"}),e.jsx(q,{href:route("platform.accounts.impersonate",{account:r.account.id}),method:"post",className:"text-blue-600 dark:text-blue-300 hover:underline",children:"Open Dashboard"})]})]}),e.jsxs(y,{className:"border-0 shadow-lg",children:[e.jsxs(b,{className:"bg-gradient-to-r from-gray-50 to-white dark:from-gray-800 dark:to-gray-900",children:[e.jsx(f,{className:"text-xl font-bold",children:"Conversation"}),e.jsx(h,{children:"Reply to the tenant"})]}),e.jsxs(j,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid gap-2 text-xs text-gray-500 dark:text-gray-400 md:grid-cols-2",children:[e.jsxs("div",{children:["Category: ",r.category||"—"]}),e.jsxs("div",{children:["Tags: ",r.tags&&r.tags.length>0?r.tags.join(", "):"—"]}),e.jsxs("div",{children:["First response due:"," ",r.first_response_due_at?new Date(r.first_response_due_at).toLocaleString():"—"]}),e.jsxs("div",{children:["Resolution due: ",r.due_at?new Date(r.due_at).toLocaleString():"—"]}),e.jsxs("div",{children:["Escalation level: ",r.escalation_level??0]})]}),r.status==="closed"&&e.jsx("div",{className:"rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm text-gray-700 dark:text-gray-200 px-4 py-3",children:"This chat is closed."}),_&&e.jsxs("div",{className:"rounded-lg border border-indigo-200 dark:border-indigo-800 bg-indigo-50/60 dark:bg-indigo-900/20 p-4 text-sm text-gray-800 dark:text-gray-200",children:[e.jsx("div",{className:"text-xs uppercase tracking-wider text-indigo-600 dark:text-indigo-300 mb-2",children:_.title}),e.jsx("div",{className:"whitespace-pre-wrap",children:_.content})]}),e.jsx("div",{className:"space-y-3",children:F.map(t=>e.jsxs("div",{className:`rounded-lg px-4 py-3 ${t.sender_type==="admin"||t.sender_type==="bot"?"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800":t.sender_type==="system"?"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800":"bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700"}`,children:[e.jsx("div",{className:"text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-1",children:t.sender_type==="admin"?"Support":t.sender_type==="bot"?"Assistant":t.sender_type==="system"?"System":"Tenant"}),e.jsx("div",{className:"text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap",children:t.body}),t.attachments&&t.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-2",children:t.attachments.map(s=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("a",{href:s.url,target:"_blank",rel:"noreferrer",className:"block text-xs text-blue-600 dark:text-blue-300 hover:underline",children:s.file_name}),X(s)&&e.jsx("img",{src:s.url,alt:s.file_name,className:"max-h-40 rounded-md border border-gray-200 dark:border-gray-700"}),Y(s)&&e.jsxs("details",{className:"text-xs text-gray-600 dark:text-gray-300",children:[e.jsx("summary",{className:"cursor-pointer",children:"Preview PDF"}),e.jsx("iframe",{src:s.url,className:"mt-2 h-48 w-full rounded-md border border-gray-200 dark:border-gray-700"})]})]},s.id))}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:new Date(t.created_at).toLocaleString()})]},t.id))}),e.jsxs("form",{onSubmit:O,className:"space-y-3",children:[e.jsx("textarea",{value:l.message,onChange:t=>v("message",t.target.value),className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",rows:4,placeholder:"Write a reply..."}),e.jsx("input",{type:"file",multiple:!0,onChange:t=>v("attachments",Array.from(t.target.files||[])),className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-gray-100 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-gray-700 hover:file:bg-gray-200 dark:file:bg-gray-800 dark:file:text-gray-200 dark:hover:file:bg-gray-700"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[r.status==="open"&&e.jsx(u,{type:"button",variant:"secondary",onClick:U,children:"Close Chat"}),N?.enabled&&e.jsx(u,{type:"button",variant:"secondary",onClick:()=>w("reply"),disabled:g,children:g?"Generating...":"AI Suggest"}),N?.enabled&&e.jsx(u,{type:"button",variant:"secondary",onClick:()=>w("summary"),disabled:g,children:g?"Generating...":"Summarize"}),N?.enabled&&e.jsx(u,{type:"button",variant:"secondary",onClick:()=>w("next_steps"),disabled:g,children:g?"Generating...":"Next Steps"}),e.jsx(u,{type:"submit",disabled:A||r.status==="closed"||l.message.trim().length===0&&l.attachments.length===0,children:A?"Sending...":"Send Reply"})]})]})]})]}),r.channel!=="live"?e.jsxs(y,{className:"border-0 shadow-lg",children:[e.jsxs(b,{className:"bg-gradient-to-r from-indigo-50 to-indigo-100 dark:from-indigo-900/20 dark:to-indigo-800/20",children:[e.jsx(f,{className:"text-xl font-bold",children:"Ticket Management"}),e.jsx(h,{children:"Update status, priority, and assignee"})]}),e.jsxs(j,{className:"p-6",children:[e.jsxs("form",{onSubmit:z,className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"Status"}),e.jsxs("select",{value:i.status,onChange:t=>x({...i,status:t.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"closed",children:"Closed"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"Priority"}),e.jsxs("select",{value:i.priority,onChange:t=>x({...i,priority:t.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"normal",children:"Normal"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"urgent",children:"Urgent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"Assignee"}),e.jsxs("select",{value:i.assigned_to,onChange:t=>x({...i,assigned_to:t.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",children:[e.jsx("option",{value:"",children:"Unassigned"}),c.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.email,")"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"Category"}),e.jsx("input",{value:i.category,onChange:t=>x({...i,category:t.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",placeholder:"Billing, WhatsApp, Templates..."})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"text-sm font-semibold text-gray-700 dark:text-gray-200",children:"Tags (comma separated)"}),e.jsx("input",{value:i.tags,onChange:t=>x({...i,tags:t.target.value}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-100",placeholder:"urgent, whatsapp, api"})]}),e.jsx("div",{className:"md:col-span-3 flex justify-end",children:e.jsx(u,{type:"submit",children:"Save Changes"})})]}),e.jsxs("div",{className:"mt-4 grid gap-2 text-xs text-gray-500 dark:text-gray-400",children:[e.jsxs("div",{children:["First response due: ",r.first_response_due_at?new Date(r.first_response_due_at).toLocaleString():"—"]}),e.jsxs("div",{children:["Resolution due: ",r.due_at?new Date(r.due_at).toLocaleString():"—"]}),e.jsxs("div",{children:["Escalation level: ",r.escalation_level??0]})]})]})]}):e.jsxs(y,{className:"border-0 shadow-lg",children:[e.jsxs(b,{className:"bg-gradient-to-r from-indigo-50 to-indigo-100 dark:from-indigo-900/20 dark:to-indigo-800/20",children:[e.jsx(f,{className:"text-xl font-bold",children:"Live Chat Summary"}),e.jsx(h,{children:"Live chat sessions do not use ticket management fields."})]}),e.jsx(j,{className:"p-6 text-sm text-gray-600 dark:text-gray-300",children:"Convert this chat to a ticket if you need assignments, priorities, and SLA tracking."})]}),e.jsxs(y,{className:"border-0 shadow-lg",children:[e.jsxs(b,{className:"bg-gradient-to-r from-slate-50 to-slate-100 dark:from-slate-900/20 dark:to-slate-800/20",children:[e.jsx(f,{className:"text-xl font-bold",children:"Audit Log"}),e.jsx(h,{children:"Recent activity on this ticket"})]}),e.jsxs(j,{className:"p-6 space-y-3",children:[d.length===0&&e.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:"No audit entries yet."}),d.map(t=>e.jsxs("div",{className:"rounded-lg border border-gray-200 dark:border-gray-800 p-3",children:[e.jsx("div",{className:"text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400",children:t.action.replace(/_/g," ")}),e.jsxs("div",{className:"text-sm text-gray-700 dark:text-gray-200 mt-1",children:[t.user?.name||"System"," · ",t.user?.email||"—"]}),t.meta&&Object.keys(t.meta).length>0&&e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:JSON.stringify(t.meta)}),e.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:t.created_at?new Date(t.created_at).toLocaleString():"—"})]},t.id))]})]})]})]})}export{ce as default};
